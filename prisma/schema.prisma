// Event Platform Database Schema
// See docs/IMPLEMENTATION-STRATEGY.md Section 5 for details

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// USER & ORGANIZATION
// =============================================================================

model User {
  id          String   @id @default(cuid())
  firebaseUid String   @unique @map("firebase_uid")
  email       String   @unique
  name        String?
  avatarUrl   String?  @map("avatar_url")

  // Email verification
  emailVerified         Boolean   @default(false) @map("email_verified")
  emailVerifiedAt       DateTime? @map("email_verified_at")
  verificationTokenHash String?   @unique @map("verification_token_hash")
  verificationExpiresAt DateTime? @map("verification_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organizations OrganizationMember[]
  events        Event[]

  @@map("users")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?  @map("logo_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members OrganizationMember[]
  events  Event[]

  @@map("organizations")
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  userId         String     @map("user_id")
  role           MemberRole @default(MEMBER)
  createdAt      DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

// =============================================================================
// EVENTS
// =============================================================================

model Event {
  id             String          @id @default(cuid())
  organizationId String?         @map("organization_id")
  creatorId      String          @map("creator_id")

  title       String
  slug        String  @unique
  description String?

  startAt  DateTime  @map("start_at")
  endAt    DateTime? @map("end_at")
  timezone String    @default("UTC")

  venueName String? @map("venue_name")
  address   String?
  city      String?
  country   String?
  latitude  Float?
  longitude Float?

  visibility EventVisibility @default(PUBLIC)
  status     EventStatus     @default(DRAFT)

  coverImageUrl String? @map("cover_image_url")
  maxAttendees  Int?    @map("max_attendees")

  // RSVP settings
  rsvpDeadline    DateTime? @map("rsvp_deadline")
  reminderDays    Int?      @map("reminder_days")      // Days after invite to remind
  reminderEnabled Boolean   @default(false) @map("reminder_enabled")

  // Custom page configuration
  templateId    String? @map("template_id")
  themePreset   String? @map("theme_preset")
  configVersion Int     @default(1) @map("config_version")
  pageConfig    Json?   @map("page_config")

  // Preview sharing
  previewToken          String?   @unique @map("preview_token")
  previewTokenExpiresAt DateTime? @map("preview_token_expires_at")

  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  organization     Organization?     @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  creator          User              @relation(fields: [creatorId], references: [id])
  invites          Invite[]
  rsvps            RSVP[]
  mediaAssets      MediaAsset[]
  pageVersions     EventPageVersion[]
  invitationConfig InvitationConfig?

  @@index([city])
  @@index([startAt])
  @@index([status, visibility])
  @@index([templateId])
  @@map("events")
}

enum EventVisibility {
  PUBLIC   // Listed in discovery, SEO indexed
  UNLISTED // Accessible via direct link only
  PRIVATE  // Invite-only, requires token
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

// =============================================================================
// INVITES & RSVP
// =============================================================================

model Invite {
  id      String @id @default(cuid())
  eventId String @map("event_id")

  email     String
  name      String?
  tokenHash String @unique @map("token_hash")

  plusOnesAllowed Int          @default(0) @map("plus_ones_allowed")
  status          InviteStatus @default(PENDING)

  expiresAt DateTime? @map("expires_at")
  sentAt    DateTime? @map("sent_at")
  openedAt  DateTime? @map("opened_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event  Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  rsvp   RSVP?
  emails EmailOutbox[]

  @@unique([eventId, email])
  @@index([email])
  @@map("invites")
}

enum InviteStatus {
  PENDING   // Created, not sent
  SENT      // Email delivered
  OPENED    // Link clicked
  RESPONDED // RSVP submitted
  BOUNCED   // Delivery failed
  EXPIRED   // Past expiry date
}

model RSVP {
  id       String  @id @default(cuid())
  inviteId String? @unique @map("invite_id")
  eventId  String  @map("event_id")

  response   RSVPResponse
  guestName  String       @map("guest_name")
  guestEmail String?      @map("guest_email")
  guestCount Int          @default(1) @map("guest_count")
  notes      String?

  respondedAt DateTime @default(now()) @map("responded_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  invite Invite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  event  Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, response])
  @@map("rsvps")
}

enum RSVPResponse {
  YES
  NO
  MAYBE
}

// =============================================================================
// EMAIL OUTBOX
// =============================================================================

model EmailOutbox {
  id       String  @id @default(cuid())
  inviteId String? @map("invite_id")

  template EmailTemplate
  toEmail  String        @map("to_email")
  subject  String
  payload  Json // Template variables

  status            EmailStatus @default(QUEUED)
  providerMessageId String?     @map("provider_message_id")
  error             String?

  scheduledFor DateTime? @map("scheduled_for")
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  openedAt     DateTime? @map("opened_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  invite Invite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([providerMessageId])
  @@map("email_outbox")
}

enum EmailTemplate {
  INVITE
  CONFIRMATION
  REMINDER
  UPDATE
  CANCELLATION
  VERIFICATION
  NO_RESPONSE_REMINDER
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  FAILED
  BOUNCED
}

// =============================================================================
// CUSTOM EVENT PAGES
// =============================================================================

model PageTemplate {
  id            String   @id
  name          String
  category      String
  description   String?
  previewUrl    String?  @map("preview_url")
  defaults      Json
  schemaVersion Int      @default(1) @map("schema_version")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([category])
  @@index([isActive])
  @@map("page_templates")
}

model MediaAsset {
  id          String    @id @default(cuid())
  eventId     String    @map("event_id")
  ownerUserId String    @map("owner_user_id")
  kind        AssetKind
  bucket      String
  path        String
  publicUrl   String?   @map("public_url")
  mimeType    String    @map("mime_type")
  sizeBytes   Int       @map("size_bytes")
  width       Int?
  height      Int?
  alt         String    @default("")
  createdAt   DateTime  @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, kind])
  @@index([ownerUserId])
  @@map("media_assets")
}

enum AssetKind {
  HERO
  GALLERY
}

model EventPageVersion {
  id            String   @id @default(cuid())
  eventId       String   @map("event_id")
  pageConfig    Json     @map("page_config")
  configVersion Int      @map("config_version")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, createdAt(sort: Desc)])
  @@map("event_page_versions")
}

// =============================================================================
// ELEGANT INVITATIONS
// =============================================================================

model InvitationConfig {
  id      String @id @default(cuid())
  eventId String @unique @map("event_id")

  // Template and theme selection
  template       InvitationTemplate @default(ENVELOPE_REVEAL)
  themeId        String             @default("ivory") @map("theme_id")
  typographyPair String             @default("classic") @map("typography_pair")

  // Content overrides (optional, falls back to Event fields)
  coupleDisplayName String? @map("couple_display_name") // Legacy: "Emma & James" format

  // Structured couple names (preferred over coupleDisplayName)
  person1Name String? @map("person1_name") // e.g., "Emma Rose Williams"
  person2Name String? @map("person2_name") // e.g., "James Oliver Smith"

  // Customizable invitation wording
  headerText    String? @map("header_text") // e.g., "Together with their families"
  eventTypeText String? @map("event_type_text") // e.g., "Request the pleasure of your company"
  monogram      String? @map("monogram") // e.g., "E&J" (auto-generated if empty)

  // Additional content
  customMessage String? @map("custom_message") // Personal message on invitation
  dressCode     String? @map("dress_code") // e.g., "Black Tie", "Casual"
  heroImageUrl  String? @map("hero_image_url") // Custom hero image for invitation

  // Locale and direction
  locale        String        @default("en-US")
  textDirection TextDirection @default(LTR) @map("text_direction")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("invitation_configs")
}

enum InvitationTemplate {
  ENVELOPE_REVEAL
  ENVELOPE_REVEAL_V2
  SPLIT_REVEAL
  LAYERED_UNFOLD
  CINEMATIC_SCROLL
  TIME_BASED_REVEAL
  GOLDEN_CARD_REVEAL
}

enum TextDirection {
  LTR
  RTL
}

// =============================================================================
// ANALYTICS TRACKING
// =============================================================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  type      String   // page_view, rsvp_form_started, rsvp_form_abandoned, section_viewed
  sessionId String   @map("session_id") // Anonymous session identifier
  data      Json?    // Flexible payload (source, field, sectionId, etc.)
  timestamp DateTime @default(now())

  @@index([eventId, type])
  @@index([eventId, timestamp])
  @@index([sessionId])
  @@map("analytics_events")
}
