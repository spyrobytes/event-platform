// Event Platform Database Schema
// See docs/IMPLEMENTATION-STRATEGY.md Section 5 for details

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// USER & ORGANIZATION
// =============================================================================

model User {
  id          String   @id @default(cuid())
  firebaseUid String   @unique @map("firebase_uid")
  email       String   @unique
  name        String?
  avatarUrl   String?  @map("avatar_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organizations OrganizationMember[]
  events        Event[]

  @@map("users")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?  @map("logo_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members OrganizationMember[]
  events  Event[]

  @@map("organizations")
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  userId         String     @map("user_id")
  role           MemberRole @default(MEMBER)
  createdAt      DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

// =============================================================================
// EVENTS
// =============================================================================

model Event {
  id             String          @id @default(cuid())
  organizationId String?         @map("organization_id")
  creatorId      String          @map("creator_id")

  title       String
  slug        String  @unique
  description String?

  startAt  DateTime  @map("start_at")
  endAt    DateTime? @map("end_at")
  timezone String    @default("UTC")

  venueName String? @map("venue_name")
  address   String?
  city      String?
  country   String?
  latitude  Float?
  longitude Float?

  visibility EventVisibility @default(PUBLIC)
  status     EventStatus     @default(DRAFT)

  coverImageUrl String? @map("cover_image_url")
  maxAttendees  Int?    @map("max_attendees")

  // Custom page configuration
  templateId    String? @map("template_id")
  themePreset   String? @map("theme_preset")
  configVersion Int     @default(1) @map("config_version")
  pageConfig    Json?   @map("page_config")

  publishedAt DateTime? @map("published_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  creator      User          @relation(fields: [creatorId], references: [id])
  invites      Invite[]
  rsvps        RSVP[]
  mediaAssets  MediaAsset[]
  pageVersions EventPageVersion[]

  @@index([city])
  @@index([startAt])
  @@index([status, visibility])
  @@index([templateId])
  @@map("events")
}

enum EventVisibility {
  PUBLIC   // Listed in discovery, SEO indexed
  UNLISTED // Accessible via direct link only
  PRIVATE  // Invite-only, requires token
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

// =============================================================================
// INVITES & RSVP
// =============================================================================

model Invite {
  id      String @id @default(cuid())
  eventId String @map("event_id")

  email     String
  name      String?
  tokenHash String @unique @map("token_hash")

  plusOnesAllowed Int          @default(0) @map("plus_ones_allowed")
  status          InviteStatus @default(PENDING)

  expiresAt DateTime? @map("expires_at")
  sentAt    DateTime? @map("sent_at")
  openedAt  DateTime? @map("opened_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event  Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  rsvp   RSVP?
  emails EmailOutbox[]

  @@unique([eventId, email])
  @@index([email])
  @@map("invites")
}

enum InviteStatus {
  PENDING   // Created, not sent
  SENT      // Email delivered
  OPENED    // Link clicked
  RESPONDED // RSVP submitted
  BOUNCED   // Delivery failed
  EXPIRED   // Past expiry date
}

model RSVP {
  id       String  @id @default(cuid())
  inviteId String? @unique @map("invite_id")
  eventId  String  @map("event_id")

  response   RSVPResponse
  guestName  String       @map("guest_name")
  guestEmail String?      @map("guest_email")
  guestCount Int          @default(1) @map("guest_count")
  notes      String?

  respondedAt DateTime @default(now()) @map("responded_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  invite Invite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  event  Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, response])
  @@map("rsvps")
}

enum RSVPResponse {
  YES
  NO
  MAYBE
}

// =============================================================================
// EMAIL OUTBOX
// =============================================================================

model EmailOutbox {
  id       String  @id @default(cuid())
  inviteId String? @map("invite_id")

  template EmailTemplate
  toEmail  String        @map("to_email")
  subject  String
  payload  Json // Template variables

  status            EmailStatus @default(QUEUED)
  providerMessageId String?     @map("provider_message_id")
  error             String?

  scheduledFor DateTime? @map("scheduled_for")
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  openedAt     DateTime? @map("opened_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  invite Invite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([providerMessageId])
  @@map("email_outbox")
}

enum EmailTemplate {
  INVITE
  CONFIRMATION
  REMINDER
  UPDATE
  CANCELLATION
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  FAILED
  BOUNCED
}

// =============================================================================
// CUSTOM EVENT PAGES
// =============================================================================

model PageTemplate {
  id            String   @id
  name          String
  category      String
  description   String?
  previewUrl    String?  @map("preview_url")
  defaults      Json
  schemaVersion Int      @default(1) @map("schema_version")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([category])
  @@index([isActive])
  @@map("page_templates")
}

model MediaAsset {
  id          String    @id @default(cuid())
  eventId     String    @map("event_id")
  ownerUserId String    @map("owner_user_id")
  kind        AssetKind
  bucket      String
  path        String
  publicUrl   String?   @map("public_url")
  mimeType    String    @map("mime_type")
  sizeBytes   Int       @map("size_bytes")
  width       Int?
  height      Int?
  alt         String    @default("")
  createdAt   DateTime  @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, kind])
  @@index([ownerUserId])
  @@map("media_assets")
}

enum AssetKind {
  HERO
  GALLERY
}

model EventPageVersion {
  id            String   @id @default(cuid())
  eventId       String   @map("event_id")
  pageConfig    Json     @map("page_config")
  configVersion Int      @map("config_version")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, createdAt(sort: Desc)])
  @@map("event_page_versions")
}
